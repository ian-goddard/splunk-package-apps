name: Package Changed Splunk Apps for Splunk Cloud
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  package-changed-apps:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Determine changed apps
        id: changed
        run: |
          CHANGED_DIRS=$(git diff --name-only HEAD^ HEAD | awk -F/ '{print $1}' | sort -u)
          CHANGED_APPS=""
          for dir in $CHANGED_DIRS; do
            if [ -d "$dir" ] && [[ "$dir" != ".github" && "$dir" != "dist" ]]; then
              CHANGED_APPS="$CHANGED_APPS $dir"
            fi
          done
          echo "Changed apps: $CHANGED_APPS"
          echo "changed_apps=$CHANGED_APPS" >> $GITHUB_OUTPUT

      - name: Package changed apps
        run: |
          mkdir -p dist
          for app in ${{ steps.changed.outputs.changed_apps }}; do
            echo "Packaging $app..."

            # Clean unwanted files
            rm -rf "$app/.git" "$app/.github"
            find "$app" -name "__pycache__" -type d -exec rm -rf {} +
            find "$app" -name "*.pyc" -delete
            find "$app" -name ".DS_Store" -delete

            # Important: package the folder itself, not its contents
            tar czf ./dist/${app}.tgz "$app"
            echo "Packaged $app -> dist/${app}.tgz"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: changed-apps-packages
          path: dist/*.tgz
