name: Package Changed Splunk Apps for Splunk Cloud

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  package-changed-apps:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      # 2️⃣ Determine changed apps
      - name: Determine changed apps
        id: changed
        run: |
          CHANGED_DIRS=$(git diff --name-only HEAD^ HEAD | awk -F/ '{print $1}' | sort -u)
          CHANGED_APPS=""
          for dir in $CHANGED_DIRS; do
            if [ -d "$dir" ] && [[ "$dir" != ".github" && "$dir" != "dist" ]]; then
              CHANGED_APPS="$CHANGED_APPS $dir"
            fi
          done
          echo "Changed apps: $CHANGED_APPS"
          echo "changed_apps=$CHANGED_APPS" >> $GITHUB_OUTPUT

      # 3️⃣ Package changed apps as .tgz
      - name: Package changed apps
        run: |
          mkdir -p dist
          for app in ${{ steps.changed.outputs.changed_apps }}; do
            echo "Packaging $app..."

            # Clean unwanted files
            rm -rf "$app/.git" "$app/.github"
            find "$app" -name "__pycache__" -type d -exec rm -rf {} +
            find "$app" -name "*.pyc" -delete
            find "$app" -name ".DS_Store" -delete

            # Package folder itself
            tar czf ./dist/${app}.tgz "$app"
            echo "Packaged $app -> dist/${app}.tgz"
          done

      # 4️⃣ Create a temporary GitHub release
      - name: Create release
        id: release
        uses: ncipollo/release-action@v1
        with:
          tag: "splunk-packages-${{ github.run_number }}"
          name: "Splunk Packages ${{ github.run_number }}"
          body: "Packages of changed Splunk apps for run ${{ github.run_number }}"
          draft: true

      # 5️⃣ Upload .tgz files to the release
      - name: Upload tgz files to release
        uses: ncipollo/release-action@v1
        with:
          artifacts: dist/*.tgz
          tag: "splunk-packages-${{ github.run_number }}"
          draft: false
